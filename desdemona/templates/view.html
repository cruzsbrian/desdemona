{% extends 'base.html' %}

{% block titlebar %}
View Match
{% endblock %}

{% block content %}

<p> Match code: <span id="matchcode"> {{ match_code }}</span> </p>
<p id="last_move">&nbsp;</p>
<p id="status">&nbsp;</p>

<table class="board">
    {% for row in range(8) %}
        <tr class="row" id="row{{row}}">
            {% for col in range(8) %}
                <td class="cell" id="cell{{row}}{{col}}">
                    <div class="piece" id="p{{row}}{{col}}"></div>
                </td>
            {% endfor %}
        </tr>
    {% endfor %}
</table>

<script>
    function setPiece(row, col, color) {
        var piece = document.getElementById("p" + row + col);
        piece.style.backgroundColor = color;
    }

    const socket = io();

    socket.on("game_update", (msg_json) => {
        msg = JSON.parse(msg_json);
        console.log(msg);

        for (var row = 0; row < 8; row++) {
            for (var col = 0; col < 8; col++) {
                val = msg.board[row][col];
                if (val === -1) { setPiece(row, col, "#fff"); }
                else if (val === 1) { setPiece(row, col, "#000"); }
                else { setPiece(row, col, "#0000"); }
            }
        }

        var last_move_str = "&nbsp;";
        if (msg.last_move !== null) {
            last_move_str = msg.last_move.color + " played (" + msg.last_move.row +
                            "," + msg.last_move.col + ")";
        }
        document.getElementById("last_move").innerHTML = last_move_str;

        var status_str = "&nbsp;";
        if (msg.status === "playing") {
            status_str = msg.turn + "'s turn";
            if (msg.ms_remaining !== null) {
                status_str += " (" + msg.ms_remaining / 1000 + "s left)";
            }
        } else {
            status_str = msg.status;
            if (msg.score !== null) {
                status_str += " (" + msg.score[0] + "-" + msg.score[1] + ")";
            }
            if (msg.status === "error") {
                status_str += ": " + msg.error;
            }
        }
        document.getElementById("status").innerHTML = status_str;
    });

    const match_code = document.getElementById("matchcode").innerText;
    socket.emit("register", JSON.stringify(
        { match_code: match_code, color: null }
    ));
</script>

{% endblock %}
